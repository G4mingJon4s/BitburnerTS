import { NS } from "@ns";

export const FILEPATH = "exploit/execute.js";

export async function main(ns: NS): Promise<void> {
	while ((globalThis as any)[`NS-${ns.pid}`] === undefined) await ns.asleep(1);
	const [task, report] = (globalThis as any)[`NS-${ns.pid}`] as [(ns: NS) => Promise<any>, (result: any) => void];
	const result = await task(ns);
	ns.atExit(() => {
		delete (globalThis as any)[`NS-${ns.pid}`];
		report(result);
	});
}

type ExecuteOptions = {
	ram: number;
	threads?: number;
	host?: string;
}

export function execute<T>(ns: NS, options: ExecuteOptions, task: (ns: NS) => Promise<T>): Promise<T> {
	return new Promise((res, rej) => {
		const host = options.host ?? ns.getHostname();
		if (!ns.fileExists(FILEPATH, host)) ns.scp(FILEPATH, host, "home");
		const pid = ns.exec(
			FILEPATH,
			host,
			{
				ramOverride: options.ram,
				temporary: true,
				threads: options.threads || 1,
			}
		);
		if (pid === 0) rej(`Failed to execute on ${host}`);
		(globalThis as any)[`NS-${pid}`] = [task, res];
	});
}

export const getRamCost = (ns: NS, functions: string[]): number => 1.6 + functions.reduce((acc, func) => acc + ns.getFunctionRamCost(func), 0);